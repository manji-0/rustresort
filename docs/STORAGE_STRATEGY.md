# RustResort ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–æˆ¦ç•¥

## æ¦‚è¦

RustResortã¯**ã‚·ãƒ³ã‚°ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹**ã‚’å‰æã¨ã—ã€ã€Œè‡ªåˆ†è¦–ç‚¹ã®æƒ…å ±ã®ã¿ã‚’DBã«æ°¸ç¶šåŒ–ã™ã‚‹ã€ã¨ã„ã†è¨­è¨ˆæ€æƒ³ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®æˆ¦ç•¥ã«ã‚ˆã‚Šã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ã‚’æœ€å°é™ã«æŠ‘ãˆã¤ã¤ã€Fediverseã¨ã®å®Œå…¨ãªç›¸äº’é‹ç”¨æ€§ã‚’ç¶­æŒã—ã¾ã™ã€‚

## è¨­è¨ˆæ€æƒ³

### ã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆ: ã€Œè‡ªåˆ†è¦–ç‚¹ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸

å¾“æ¥ã®ActivityPubã‚µãƒ¼ãƒãƒ¼ã¯ã€ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµŒç”±ã§å—ä¿¡ã—ãŸå…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’DBã«ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã¯è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã¯å¿…è¦ã§ã™ãŒã€ã‚·ãƒ³ã‚°ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã¯éå‰°ã§ã™ã€‚

RustResortã§ã¯ä»¥ä¸‹ã®åŸå‰‡ã‚’æ¡ç”¨ã—ã¾ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ã®åŸå‰‡                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ è‡ªåˆ†ãŒä½œæˆã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ â†’ DBæ°¸ç¶šåŒ–                      â”‚
â”‚  âœ“ è‡ªåˆ†ãŒã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ â†’ DBæ°¸ç¶šåŒ–                â”‚
â”‚     (Repost, Fav, Bookmark)                                 â”‚
â”‚  âœ“ ãƒ•ã‚©ãƒ­ãƒ¼é–¢ä¿‚ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ â†’ DBæ°¸ç¶šåŒ–                        â”‚
â”‚  âœ— ä»–è€…ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³toot â†’ ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿ï¼ˆæ®ç™ºæ€§ï¼‰   â”‚
â”‚  âœ— ä»–è€…ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å…¨æ–‡ â†’ ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿ï¼ˆæ®ç™ºæ€§ï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚·ãƒ³ã‚°ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰æ

- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯**adminãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿**ãŒå­˜åœ¨
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»è¿½åŠ æ©Ÿèƒ½ã¯å®Ÿè£…ã—ãªã„
- å…¨ã¦ã®æ“ä½œã¯å˜ä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦–ç‚¹ã‹ã‚‰è¡Œã‚ã‚Œã‚‹

## ãƒ‡ãƒ¼ã‚¿åˆ†é¡ã¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æˆ¦ç•¥

### 1. æ°¸ç¶šåŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆDBä¿å­˜ï¼‰

ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã¯SQLiteã«æ°¸ç¶šä¿å­˜ã•ã‚Œã¾ã™ï¼š

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | èª¬æ˜ | ç†ç”± |
|-----------|------|------|
| è‡ªåˆ†ã®Status | è‡ªåˆ†ãŒä½œæˆã—ãŸæŠ•ç¨¿ | ã‚³ã‚¢è³‡ç”£ |
| ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ | S3ä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®å‚ç…§æƒ…å ± | ã‚³ã‚¢è³‡ç”£ï¼ˆå®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã¯S3ï¼‰ |
| Repostã—ãŸä»–è€…ã®Status | ãƒ–ãƒ¼ã‚¹ãƒˆå¯¾è±¡ | è‡ªåˆ†ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
| Favã—ãŸä»–è€…ã®Status | ãŠæ°—ã«å…¥ã‚Šå¯¾è±¡ | è‡ªåˆ†ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
| Bookmarkã—ãŸä»–è€…ã®Status | ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯å¯¾è±¡ | è‡ªåˆ†ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
| ãƒ•ã‚©ãƒ­ãƒ¼é–¢ä¿‚ã‚¢ãƒ‰ãƒ¬ã‚¹ | `user@domain` å½¢å¼ | é–¢ä¿‚æ€§ã®ç¶­æŒ |
| **é€šçŸ¥** | ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã€Likeã€ãƒ–ãƒ¼ã‚¹ãƒˆç­‰ | å±¥æ­´ä¿æŒ |
| ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ­ãƒƒã‚¯ | ãƒ–ãƒ­ãƒƒã‚¯ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ | ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š |
| ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­å®š | å„ç¨®è¨­å®šå€¤ | å‹•ä½œã«å¿…è¦ |

### 2. æ®ç™ºæ€§ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰

ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ¡ãƒ¢ãƒªã«ã®ã¿ä¿æŒã•ã‚Œã€å†èµ·å‹•ã§æ¶ˆå¤±ã—ã¾ã™ï¼š

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚º | ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« |
|-----------|-----------------|---------------|
| ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³toot | æœ€æ–°2000ä»¶ | LRUã§è‡ªå‹•å‰Šé™¤ |
| ãƒ•ã‚©ãƒ­ã‚¤ãƒ¼/ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« | å…¨ä»¶ | èµ·å‹•æ™‚å–å¾—ã€Federationã§æ›´æ–° |
| ãƒªãƒ¢ãƒ¼ãƒˆã‚¢ã‚¯ã‚¿ãƒ¼ã®å…¬é–‹éµ | LRU 1000ä»¶ | ç½²åæ¤œè¨¼æ™‚ã«å–å¾— |

### 3. ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆCloudflare R2ï¼‰

ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã¯Cloudflare R2ã«ä¿å­˜ã•ã‚Œã€Custom DomainçµŒç”±ã§å…¬é–‹ã•ã‚Œã¾ã™ï¼š

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | ä¿å­˜å…ˆ | å…¬é–‹URLä¾‹ |
|-----------|--------|---------|
| ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ | R2 | `https://media.example.com/avatars/{id}.webp` |
| ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒ | R2 | `https://media.example.com/headers/{id}.webp` |
| æŠ•ç¨¿æ·»ä»˜ãƒ¡ãƒ‡ã‚£ã‚¢ | R2 | `https://media.example.com/attachments/{id}.webp` |
| ã‚µãƒ ãƒã‚¤ãƒ« | R2 | `https://media.example.com/thumbnails/{id}.webp` |

**ãƒ¡ãƒ‡ã‚£ã‚¢é…ä¿¡ãƒ•ãƒ­ãƒ¼:**
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒ‡ã‚£ã‚¢ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ RustResortãŒR2ã«ä¿å­˜
2. ãƒ¡ãƒ‡ã‚£ã‚¢URLã¯ `https://media.example.com/...` (R2 Custom Domain)
3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯CDNçµŒç”±ã§R2ã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆRustResortã‚’çµŒç”±ã—ãªã„ï¼‰

è©³ç´°ã¯ [CLOUDFLARE.md](./CLOUDFLARE.md) ã‚’å‚ç…§ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Federation                               â”‚
â”‚                    (Incoming Activities)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Activity Router                             â”‚
â”‚         Create / Announce / Like / Follow / Update ...          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Persist Path   â”‚ â”‚   Cache Path    â”‚ â”‚  Ignore Path    â”‚
â”‚  (è‡ªåˆ†ã«é–¢ä¿‚)    â”‚ â”‚  (å‚ç…§ã®ã¿)     â”‚ â”‚  (é–¢ä¿‚ãªã—)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚
         â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     SQLite      â”‚ â”‚  Memory Cache   â”‚
â”‚   (Permanent)   â”‚ â”‚   (Volatile)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è©³ç´°è¨­è¨ˆ

### ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```rust
use moka::future::Cache;
use std::sync::Arc;

/// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆæœ€å¤§2000ä»¶ã€LRUï¼‰
pub struct TimelineCache {
    /// Status ID -> CachedStatus
    statuses: Cache<String, Arc<CachedStatus>>,
    /// æœ€å¤§ä¿æŒä»¶æ•°
    max_items: usize,
}

/// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨Statusï¼ˆè»½é‡ç‰ˆï¼‰
#[derive(Debug, Clone)]
pub struct CachedStatus {
    pub id: String,
    pub uri: String,
    pub content: String,
    pub account_address: String,  // user@domain
    pub created_at: DateTime<Utc>,
    pub visibility: Visibility,
    pub attachments: Vec<CachedAttachment>,
    pub reply_to_uri: Option<String>,
    pub boost_of_uri: Option<String>,
    // Note: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè©³ç´°ã¯å«ã¾ãªã„ï¼ˆåˆ¥ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‚ç…§ï¼‰
}

impl TimelineCache {
    pub fn new(max_items: usize) -> Self {
        Self {
            statuses: Cache::builder()
                .max_capacity(max_items as u64)
                .time_to_live(Duration::from_secs(3600 * 24 * 7)) // 7æ—¥
                .build(),
            max_items,
        }
    }
    
    /// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«è¿½åŠ ï¼ˆè‡ªå‹•ã§LRUå‰Šé™¤ï¼‰
    pub async fn insert(&self, status: CachedStatus) {
        self.statuses.insert(status.id.clone(), Arc::new(status)).await;
    }
    
    /// ãƒ›ãƒ¼ãƒ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å–å¾—
    pub async fn get_home_timeline(
        &self,
        followee_addresses: &HashSet<String>,
        limit: usize,
        max_id: Option<&str>,
    ) -> Vec<Arc<CachedStatus>> {
        // ãƒ•ã‚©ãƒ­ã‚¤ãƒ¼ã®Statusã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦è¿”ã™
        // ...
    }
}
```

### ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥

```rust
/// ãƒ•ã‚©ãƒ­ã‚¤ãƒ¼/ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
pub struct ProfileCache {
    /// user@domain -> CachedProfile
    profiles: Cache<String, Arc<CachedProfile>>,
}

#[derive(Debug, Clone)]
pub struct CachedProfile {
    pub address: String,           // user@domain
    pub uri: String,               // ActivityPub URI
    pub display_name: Option<String>,
    pub note: Option<String>,
    pub avatar_url: Option<String>,
    pub header_url: Option<String>,
    pub public_key_pem: String,
    pub inbox_uri: String,
    pub outbox_uri: Option<String>,
    pub followers_count: Option<u64>,
    pub following_count: Option<u64>,
    pub fetched_at: DateTime<Utc>,
}

impl ProfileCache {
    /// èµ·å‹•æ™‚ã«DBä¿å­˜ã®ãƒ•ã‚©ãƒ­ãƒ¼é–¢ä¿‚ã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¸€æ‹¬å–å¾—
    pub async fn initialize_from_follows(
        &self,
        follow_addresses: Vec<String>,
        http_client: &HttpClient,
    ) {
        for address in follow_addresses {
            match self.fetch_profile(&address, http_client).await {
                Ok(profile) => {
                    self.profiles.insert(address, Arc::new(profile)).await;
                }
                Err(e) => {
                    tracing::warn!(%address, error = %e, "Failed to fetch profile at startup");
                }
            }
        }
    }
    
    /// FederationçµŒç”±ã®Update Activityã§æ›´æ–°
    pub async fn update_from_activity(&self, actor: &ActivityActor) {
        let address = format!("{}@{}", actor.preferred_username, actor.domain);
        if let Some(existing) = self.profiles.get(&address).await {
            let updated = CachedProfile {
                display_name: actor.name.clone(),
                note: actor.summary.clone(),
                avatar_url: actor.icon_url(),
                header_url: actor.image_url(),
                fetched_at: Utc::now(),
                ..(*existing).clone()
            };
            self.profiles.insert(address, Arc::new(updated)).await;
        }
    }
}
```

### æ°¸ç¶šåŒ–åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

```rust
/// Activityã®æ°¸ç¶šåŒ–åˆ¤å®š
pub enum PersistenceDecision {
    /// DBã«æ°¸ç¶šä¿å­˜
    Persist,
    /// ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿
    CacheOnly,
    /// ä¿å­˜ã—ãªã„
    Ignore,
}

impl ActivityProcessor {
    /// å—ä¿¡ã—ãŸActivityã®æ°¸ç¶šåŒ–åˆ¤å®š
    pub fn decide_persistence(&self, activity: &Activity) -> PersistenceDecision {
        match &activity.activity_type {
            // è‡ªåˆ†ã¸ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ â†’ é€šçŸ¥ã‚’DBä¿å­˜ + å…ƒStatusã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            ActivityType::Create if self.mentions_me(&activity) => {
                // é€šçŸ¥ã¯DBã«æ°¸ç¶šåŒ–ã€Statusè‡ªä½“ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥
                PersistenceDecision::Persist  // é€šçŸ¥éƒ¨åˆ†
            }
            
            // ãƒ•ã‚©ãƒ­ã‚¤ãƒ¼ã®æŠ•ç¨¿ â†’ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿
            ActivityType::Create if self.is_followee(&activity.actor) => {
                PersistenceDecision::CacheOnly
            }
            
            // èª°ã‹ãŒè‡ªåˆ†ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ â†’ ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã‚¢ãƒ‰ãƒ¬ã‚¹ + é€šçŸ¥ã‚’DBä¿å­˜
            ActivityType::Follow if self.targets_me(&activity) => {
                PersistenceDecision::Persist
            }
            
            // è‡ªåˆ†ã®æŠ•ç¨¿ã¸ã®Like â†’ é€šçŸ¥ã‚’DBä¿å­˜
            ActivityType::Like if self.is_my_status(&activity.object) => {
                PersistenceDecision::Persist  // é€šçŸ¥ã¨ã—ã¦æ°¸ç¶šåŒ–
            }
            
            // è‡ªåˆ†ã®æŠ•ç¨¿ã®ãƒ–ãƒ¼ã‚¹ãƒˆ â†’ é€šçŸ¥ã‚’DBä¿å­˜
            ActivityType::Announce if self.is_my_status(&activity.object) => {
                PersistenceDecision::Persist  // é€šçŸ¥ã¨ã—ã¦æ°¸ç¶šåŒ–
            }
            
            // ãã®ä»– â†’ ç„¡è¦–
            _ => PersistenceDecision::Ignore,
        }
    }
}
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹æ°¸ç¶šåŒ–

```rust
/// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹ä»–è€…Statusã®æ°¸ç¶šåŒ–
impl StatusService {
    /// Repostï¼ˆãƒ–ãƒ¼ã‚¹ãƒˆï¼‰
    pub async fn repost(&self, status_uri: &str) -> Result<Status, Error> {
        // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰Statusã‚’å–å¾—
        let cached = self.timeline_cache.get_by_uri(status_uri).await
            .ok_or(Error::NotFound)?;
        
        // 2. ä»–è€…ã®Statusã‚’DBã«æ°¸ç¶šåŒ–ï¼ˆã¾ã ä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
        let persisted = self.persist_remote_status(&cached).await?;
        
        // 3. Reposté–¢ä¿‚ã‚’DBã«ä¿å­˜
        self.db.insert_repost(&self.my_account_id, &persisted.id).await?;
        
        // 4. Announce Activityã‚’é…ä¿¡
        self.federation.send_announce(&persisted).await?;
        
        Ok(persisted)
    }
    
    /// ãŠæ°—ã«å…¥ã‚Š
    pub async fn favourite(&self, status_uri: &str) -> Result<(), Error> {
        let cached = self.timeline_cache.get_by_uri(status_uri).await
            .ok_or(Error::NotFound)?;
        
        // ä»–è€…ã®Statusã‚’DBã«æ°¸ç¶šåŒ–
        let persisted = self.persist_remote_status(&cached).await?;
        
        // Favouriteé–¢ä¿‚ã‚’DBã«ä¿å­˜
        self.db.insert_favourite(&self.my_account_id, &persisted.id).await?;
        
        // Like Activityã‚’é…ä¿¡
        self.federation.send_like(&persisted).await?;
        
        Ok(())
    }
    
    /// ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã€Federationãªã—ï¼‰
    pub async fn bookmark(&self, status_uri: &str) -> Result<(), Error> {
        let cached = self.timeline_cache.get_by_uri(status_uri).await
            .ok_or(Error::NotFound)?;
        
        // ä»–è€…ã®Statusã‚’DBã«æ°¸ç¶šåŒ–
        let persisted = self.persist_remote_status(&cached).await?;
        
        // Bookmarké–¢ä¿‚ã‚’DBã«ä¿å­˜
        self.db.insert_bookmark(&self.my_account_id, &persisted.id).await?;
        
        Ok(())
    }
    
    /// ã‚­ãƒ£ãƒƒã‚·ãƒ¥Statusã‚’DBã«æ°¸ç¶šåŒ–
    async fn persist_remote_status(&self, cached: &CachedStatus) -> Result<Status, Error> {
        // æ—¢ã«DBã«ã‚ã‚‹å ´åˆã¯ãã‚Œã‚’è¿”ã™
        if let Some(existing) = self.db.get_status_by_uri(&cached.uri).await? {
            return Ok(existing);
        }
        
        // æ–°è¦ä¿å­˜
        let status = Status {
            id: EntityId::new(),
            uri: cached.uri.clone(),
            content: cached.content.clone(),
            account_address: cached.account_address.clone(),
            // ...
            persisted_reason: PersistedReason::UserAction,
        };
        
        self.db.insert_status(&status).await?;
        Ok(status)
    }
}

/// Statusæ°¸ç¶šåŒ–ã®ç†ç”±
#[derive(Debug, Clone, PartialEq)]
pub enum PersistedReason {
    /// è‡ªåˆ†ãŒä½œæˆ
    OwnContent,
    /// Repostå¯¾è±¡
    Reposted,
    /// ãŠæ°—ã«å…¥ã‚Šå¯¾è±¡
    Favourited,
    /// ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯å¯¾è±¡
    Bookmarked,
    /// è‡ªåˆ†ã®æŠ•ç¨¿ã¸ã®ãƒªãƒ—ãƒ©ã‚¤ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¿æŒç”¨ï¼‰
    ReplyToOwn,
}
```

### ãƒ•ã‚©ãƒ­ãƒ¼é–¢ä¿‚ã®DBè¨­è¨ˆ

```rust
/// ãƒ•ã‚©ãƒ­ãƒ¼é–¢ä¿‚ï¼ˆã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ä¿å­˜ï¼‰
#[derive(Debug, Clone)]
pub struct Follow {
    pub id: EntityId,
    pub created_at: DateTime<Utc>,
    /// ãƒ•ã‚©ãƒ­ãƒ¼å…ˆã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆuser@domainï¼‰
    pub target_address: String,
    /// ActivityPub URIï¼ˆAccept/Undoç”¨ï¼‰
    pub uri: String,
}

/// ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ï¼ˆã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ä¿å­˜ï¼‰
#[derive(Debug, Clone)]
pub struct Follower {
    pub id: EntityId,
    pub created_at: DateTime<Utc>,
    /// ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆuser@domainï¼‰
    pub follower_address: String,
    /// ActivityPub URI
    pub uri: String,
}
```

SQLãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³:
```sql
-- ãƒ•ã‚©ãƒ­ãƒ¼é–¢ä¿‚ï¼ˆè‡ªåˆ†ãŒãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ç›¸æ‰‹ï¼‰
CREATE TABLE follows (
    id TEXT PRIMARY KEY,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    target_address TEXT NOT NULL UNIQUE,  -- user@domain
    uri TEXT NOT NULL UNIQUE
);

-- ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ï¼ˆè‡ªåˆ†ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹ç›¸æ‰‹ï¼‰
CREATE TABLE followers (
    id TEXT PRIMARY KEY,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    follower_address TEXT NOT NULL UNIQUE,  -- user@domain
    inbox_uri TEXT NOT NULL,  -- é…ä¿¡å…ˆï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚‚ã‚ã‚‹ãŒé…ä¿¡ç¢ºå®Ÿæ€§ã®ãŸã‚ä¿æŒï¼‰
    uri TEXT NOT NULL UNIQUE
);
```

### èµ·å‹•æ™‚ã®åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼

```rust
impl AppState {
    pub async fn initialize() -> Result<Self, Error> {
        // 1. DBæ¥ç¶š
        let db = Database::connect(&config.database_url).await?;
        
        // 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆæœŸåŒ–
        let timeline_cache = TimelineCache::new(2000);
        let profile_cache = ProfileCache::new();
        
        // 3. ãƒ•ã‚©ãƒ­ãƒ¼é–¢ä¿‚ã‚’DBã‹ã‚‰èª­ã¿è¾¼ã¿
        let follow_addresses = db.get_all_follow_addresses().await?;
        let follower_addresses = db.get_all_follower_addresses().await?;
        
        // 4. ãƒ•ã‚©ãƒ­ã‚¤ãƒ¼/ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¸¦åˆ—å–å¾—
        let http_client = HttpClient::new();
        
        tokio::join!(
            profile_cache.initialize_from_addresses(&follow_addresses, &http_client),
            profile_cache.initialize_from_addresses(&follower_addresses, &http_client),
        );
        
        tracing::info!(
            follows = follow_addresses.len(),
            followers = follower_addresses.len(),
            "Initialized profile cache"
        );
        
        // 5. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¯ç©ºã®çŠ¶æ…‹ã§é–‹å§‹
        // â†’ Federationã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å—ä¿¡ã™ã‚‹ã‹ã€
        //   ãƒ•ã‚©ãƒ­ã‚¤ãƒ¼ã®Outboxã‹ã‚‰æœ€æ–°ã‚’å–å¾—ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚ã‚Š
        
        Ok(Self {
            db: Arc::new(db),
            timeline_cache: Arc::new(timeline_cache),
            profile_cache: Arc::new(profile_cache),
            http_client: Arc::new(http_client),
            // ...
        })
    }
}
```

## DBã‚¹ã‚­ãƒ¼ãƒï¼ˆæœ€å°æ§‹æˆï¼‰

```sql
-- è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ï¼ˆ1ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã¿ï¼‰
CREATE TABLE account (
    id TEXT PRIMARY KEY,
    username TEXT NOT NULL UNIQUE,
    display_name TEXT,
    note TEXT,
    avatar_s3_key TEXT,     -- S3ä¸Šã®ã‚­ãƒ¼
    header_s3_key TEXT,     -- S3ä¸Šã®ã‚­ãƒ¼
    private_key_pem TEXT NOT NULL,
    public_key_pem TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- è‡ªåˆ†ã®æŠ•ç¨¿ + æ°¸ç¶šåŒ–ã•ã‚ŒãŸä»–è€…ã®æŠ•ç¨¿
CREATE TABLE statuses (
    id TEXT PRIMARY KEY,
    uri TEXT NOT NULL UNIQUE,
    content TEXT NOT NULL,
    content_warning TEXT,
    visibility TEXT NOT NULL,
    language TEXT,
    account_address TEXT NOT NULL,  -- è‡ªåˆ†ã®å ´åˆã¯ç©ºæ–‡å­—åˆ—
    is_local INTEGER NOT NULL DEFAULT 0,
    in_reply_to_uri TEXT,
    boost_of_uri TEXT,
    persisted_reason TEXT NOT NULL,  -- own/reposted/favourited/bookmarked/reply_to_own
    created_at TIMESTAMP NOT NULL,
    fetched_at TIMESTAMP
);

-- ãƒ¡ãƒ‡ã‚£ã‚¢æ·»ä»˜ï¼ˆS3ã‚­ãƒ¼ã‚’ä¿å­˜ã€å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã¯S3ä¸Šï¼‰
CREATE TABLE media_attachments (
    id TEXT PRIMARY KEY,
    status_id TEXT,
    s3_key TEXT NOT NULL,           -- S3ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚­ãƒ¼
    thumbnail_s3_key TEXT,          -- ã‚µãƒ ãƒã‚¤ãƒ«ã®S3ã‚­ãƒ¼
    content_type TEXT NOT NULL,
    file_size INTEGER NOT NULL,
    description TEXT,
    blurhash TEXT,
    width INTEGER,
    height INTEGER,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (status_id) REFERENCES statuses(id)
);

-- é€šçŸ¥ï¼ˆæ°¸ç¶šåŒ–ï¼‰
CREATE TABLE notifications (
    id TEXT PRIMARY KEY,
    notification_type TEXT NOT NULL,  -- mention/favourite/reblog/follow/follow_request
    origin_account_address TEXT NOT NULL,  -- user@domain
    status_uri TEXT,                  -- é–¢é€£Statusã®URIï¼ˆã‚ã‚Œã°ï¼‰
    read INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);
CREATE INDEX idx_notifications_read ON notifications(read);

-- ãƒ•ã‚©ãƒ­ãƒ¼é–¢ä¿‚
CREATE TABLE follows (
    id TEXT PRIMARY KEY,
    target_address TEXT NOT NULL UNIQUE,
    uri TEXT NOT NULL UNIQUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼
CREATE TABLE followers (
    id TEXT PRIMARY KEY,
    follower_address TEXT NOT NULL UNIQUE,
    inbox_uri TEXT NOT NULL,
    uri TEXT NOT NULL UNIQUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- ãŠæ°—ã«å…¥ã‚Š
CREATE TABLE favourites (
    id TEXT PRIMARY KEY,
    status_id TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (status_id) REFERENCES statuses(id),
    UNIQUE (status_id)
);

-- ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯
CREATE TABLE bookmarks (
    id TEXT PRIMARY KEY,
    status_id TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (status_id) REFERENCES statuses(id),
    UNIQUE (status_id)
);

-- Reposté–¢ä¿‚
CREATE TABLE reposts (
    id TEXT PRIMARY KEY,
    status_id TEXT NOT NULL,
    uri TEXT NOT NULL UNIQUE,  -- Announce Activity URI
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (status_id) REFERENCES statuses(id),
    UNIQUE (status_id)
);

-- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ­ãƒƒã‚¯
CREATE TABLE domain_blocks (
    id TEXT PRIMARY KEY,
    domain TEXT NOT NULL UNIQUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­å®š
CREATE TABLE settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_statuses_created_at ON statuses(created_at DESC);
CREATE INDEX idx_statuses_account_address ON statuses(account_address);
CREATE INDEX idx_statuses_persisted_reason ON statuses(persisted_reason);
```

## åˆ©ç‚¹ã¨åˆ¶ç´„

### åˆ©ç‚¹

| åˆ©ç‚¹ | èª¬æ˜ |
|------|------|
| ğŸ’¾ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç¯€ç´„ | DBã‚µã‚¤ã‚ºãŒåŠ‡çš„ã«å°ã•ããªã‚‹ |
| âš¡ é«˜é€Ÿèµ·å‹• | DBã‹ã‚‰ã®èª­ã¿è¾¼ã¿ãŒæœ€å°é™ |
| ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ | ä»–è€…ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ãªã„ |
| ğŸ§¹ ç®¡ç†ä¸è¦ | è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒä¸è¦ |
| ğŸ¯ ã‚·ãƒ³ãƒ—ãƒ« | ã‚·ãƒ³ã‚°ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰¹åŒ–ã§è¤‡é›‘ã•å‰Šæ¸› |

### åˆ¶ç´„

| åˆ¶ç´„ | èª¬æ˜ | å¯¾å‡¦ |
|------|------|------|
| ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®å±¥æ­´ | å†èµ·å‹•ã§æ¶ˆå¤± | é‡è¦ãªã‚‚ã®ã¯Bookmark |
| æ¤œç´¢æ©Ÿèƒ½ | ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†…ã®ã¿ | è‡ªåˆ†ã®æŠ•ç¨¿ã¯å…¨æ–‡æ¤œç´¢å¯èƒ½ |
| ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ | ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç©º | èµ·å‹•æ™‚ã«Outboxå–å¾—ã‚ªãƒ—ã‚·ãƒ§ãƒ³ |
| S3å¿…é ˆ | ãƒ¡ãƒ‡ã‚£ã‚¢ä¿å­˜ã«S3ãŒå¿…è¦ | MinIOç­‰ã®ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆã‚‚å¯ |

## è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³

```toml
[cache]
# ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ€å¤§ä»¶æ•°
timeline_max_items = 2000

# ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥TTLï¼ˆç§’ï¼‰
profile_ttl = 86400  # 24æ™‚é–“

[storage]
# S3äº’æ›ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆå¿…é ˆï¼‰
endpoint = "https://s3.amazonaws.com"
bucket = "my-rustresort-media"
region = "ap-northeast-1"
# access_key ã¨ secret_key ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰

[startup]
# èµ·å‹•æ™‚ã«ãƒ•ã‚©ãƒ­ã‚¤ãƒ¼ã®Outboxã‹ã‚‰æœ€æ–°æŠ•ç¨¿ã‚’å–å¾—ã™ã‚‹ã‹
fetch_followee_outbox = true

# Outboxã‹ã‚‰å–å¾—ã™ã‚‹æœ€å¤§ä»¶æ•°
outbox_fetch_limit = 50
```

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- [DATA_MODEL.md](./DATA_MODEL.md) - è©³ç´°ãªãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
- [FEDERATION.md](./FEDERATION.md) - ãƒ•ã‚§ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†
